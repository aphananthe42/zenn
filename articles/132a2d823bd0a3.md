---
title: "ãƒ‡ãƒã‚¤ã‚¹é–“ã§Pushé€šçŸ¥ã‚’é€ã‚Šåˆã† with SwiftUI, Firebase Cloud Messaging"
emoji: "ğŸ“©"
type: "tech"
topics:
  - "firebase"
  - "swift"
  - "swiftui"
published: true
published_at: "2021-07-15 18:12"
---

# ã¯ã˜ã‚ã«

Firebase Cloud Messagingã‚’ä½¿ç”¨ã—ã€ãƒ‡ãƒã‚¤ã‚¹ to ãƒ‡ãƒã‚¤ã‚¹ã§Pushé€šçŸ¥ã‚’é€ã‚‹å®Ÿè£…ã‚’æ›¸ã„ã¦ã¿ã¾ã—ãŸã€‚
Pushé€šçŸ¥ã¨ã„ã†ã¨Firebase Consoleã‹ã‚‰ã‚°ãƒ«ãƒ¼ãƒ—ã¸é€šçŸ¥ã‚’æ‰“ãŸã‚Œã‚‹ã“ã¨ãŒå¤šã„ã‹ã¨æ€ã„ã¾ã™ã€‚
ä»Šå›ã¯ãã†ã§ã¯ãªãã€ã‚¢ãƒ—ãƒªãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ä»–ã®ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒã‚¤ã‚¹ã¸å‘ã‘ã¦Pushé€šçŸ¥ã‚’é€ã‚‹æ–¹æ³•ã‚’SwiftUIã§è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¨ã—ã¦ã¯ã€ä¾‹ãˆã°å¯¾æˆ¦ã‚²ãƒ¼ãƒ ãªã©ã§å¯¾æˆ¦å¾…ã¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‹é”ã«å‘ã‹ã£ã¦ã€Œå¯¾æˆ¦ã—ã‚ˆã†ã€ã¨ã„ã†æ—¨ã®Pushé€šçŸ¥ã‚’é€ã£ãŸã‚Šç­‰ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ç›¸æ‰‹ã«ã‚¢ãƒ—ãƒªèµ·å‹•ã‚’ä¿ƒã™å ´é¢ãªã©ã§ä½¿ãˆã‚‹ã®ã§ã¯ã¨æ€ã„ã¾ã™ã€‚

å¤§é›‘æŠŠãªä¸€é€£ã®æµã‚Œã¨ã—ã¦ã¯ã€
1. ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«ç«¯æœ«ã‹ã‚‰Firebase Cloud Messaging Token(ä»¥ä¸‹FCM Token)ã‚’å–å¾—
2. å–å¾—ã—ãŸFCM Tokenã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç­‰ã«ä¿å­˜(ã“ã“ã§ã¯Firebase Realtime Databaseã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™)
3. ã‚¢ãƒ—ãƒªå†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»–ã®ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‘ã‹ã£ã¦Pushé€šçŸ¥ã‚’é€ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’èµ·ã“ã™(Buttonã‚¿ãƒƒãƒ—ç­‰)
4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã—ã¦ã‚ã‚‹é€ä¿¡å…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®FCM Tokenã‚’ä½¿ã£ã¦ã€FCMã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹Pushé€šçŸ¥é€ä¿¡APIã‚’å©ã -> Pushé€šçŸ¥ãŒæ‰“ãŸã‚Œã‚‹
5. Pushé€šçŸ¥ã‚’å—ã‘å–ã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€šçŸ¥ã‚’ã‚¿ãƒƒãƒ—
6. ã‚¢ãƒ—ãƒªèµ·å‹•å¾Œã€ç‰¹å®šç”»é¢ã«é·ç§»

å¤§é›‘æŠŠã«æ›¸ãã¨ã“ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
å±Šã„ãŸPushé€šçŸ¥ã‚’ã‚¿ãƒƒãƒ—å¾Œã€ç†æƒ³ã¨ã—ã¦ã¯ã€Œé€šçŸ¥ã‚’é€ã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã‚‹ç”»é¢ã€ã¨åŒã˜ç”»é¢ã‚’é–‹ããŸã„ã®ã§ã€é€šçŸ¥ã‚¿ãƒƒãƒ—å¾Œã«ç‰¹å®šç”»é¢ã«é·ç§»ã™ã‚‹ã¾ã§ã‚’ã‚„ã£ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# å‰æ

OS: iOS14.0 ~
Interface: SwiftUI
Life Cycle: SwiftUI App
ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç®¡ç†ãƒ„ãƒ¼ãƒ«: Swift Package Manager 
-> Firebase iOS SDK v8.0.0ã‹ã‚‰æ­£å¼ã«SPMãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸğŸ‰

- ã‚¢ãƒ—ãƒªã‚’Firebaseã«ç™»éŒ²æ¸ˆã¿
- Firebaseãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¸ˆã¿
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯Realtime Databaseã‚’ä½¿ç”¨

# 0. CloudMessagingã®è¨­å®š

ã‚¢ãƒ—ãƒªã§Pushé€šçŸ¥ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã€APNsè¨¼æ˜æ›¸ã‚’ä½œæˆã—ãŸã‚Šã€ä½œæˆã—ãŸè¨¼æ˜æ›¸ã‚’Firebase Consoleã«ç™»éŒ²ã—ãŸã‚Šã€è‰²ã€…æº–å‚™ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã“ã§ã¯ã™ã§ã«è¨­å®šæ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã‚’å‰æã«ã—ã¦ã„ã¾ã™ãŒã€è©³ç´°ãªè¨­å®šæ–¹æ³•ã¯ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ãŒå¤§å¤‰å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚
[ã€Swift5ã€‘ãƒªãƒ¢ãƒ¼ãƒˆãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®å®Ÿè£…æ–¹æ³•](https://note.com/t0_inoue/n/nb817e740654b)
ä¸€é€šã‚Šè¨­å®šã—çµ‚ã‚ã£ãŸã‚ã¨ã®App.swiftã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã«ãªã‚Šã¾ã™ã€‚

```swift: ExampleApp.swift
import SwiftUI
import UserNotifications
import Firebase
import FirebaseMessaging

@main
struct ExampleApp: App {
   @UIApplicationDelegateAdaptor(AppDelegate.self) var delegate
   var body: some Scene {
      WindowGroup {
         HomeView()
      }
   }
}

// MARK: - AppDelegate Main
class AppDelegate: NSObject, UIApplicationDelegate, MessagingDelegate {
   func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]? = nil) -> Bool {
      FirebaseApp.configure()
      Messaging.messaging().delegate = self
      UNUserNotificationCenter.current().delegate = self
      
      // Pushé€šçŸ¥è¨±å¯ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
      let authOptions: UNAuthorizationOptions = [.alert, .badge, .sound]
      UNUserNotificationCenter.current().requestAuthorization(options: authOptions) { granted, _ in
         guard granted else { return }
         DispatchQueue.main.async {
            application.registerForRemoteNotifications()
         }
      }
      return true
   }
}

// MARK: - AppDelegate Push Notification
extension AppDelegate: UNUserNotificationCenterDelegate {
   func application(_ application: UIApplication, didReceiveRemoteNotification userInfo: [AnyHashable: Any], fetchCompletionHandler completionHandler: @escaping (UIBackgroundFetchResult) -> Void) {
       if let messageID = userInfo["gcm.message_id"] {
          print("MessageID: \(messageID)")
       }
       print(userInfo)
       completionHandler(.newData)
   }
   
   // ã‚¢ãƒ—ãƒªãŒForegroundæ™‚ã«Pushé€šçŸ¥ã‚’å—ä¿¡ã™ã‚‹å‡¦ç†
   func userNotificationCenter(_ center: UNUserNotificationCenter, willPresent notification: UNNotification, withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void) {
      completionHandler([.banner, .sound])
   }
```

# 1. ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«ç«¯æœ«ã‹ã‚‰FCM Tokenã‚’å–å¾— -> ä¿å­˜

CloudMessagingã¯ã‚¢ãƒ—ãƒªã®èµ·å‹•æ™‚ã«ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç™»éŒ²ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã„ã†ã‚‚ã®ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãªã©ä¸€æ„ãªã‚‚ã®ã«ç´ä»˜ã‘ã¦ãŠã‘ã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰åˆ¥ã®ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‘ã‘ã¦Pushé€šçŸ¥ã‚’é€ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä¾‹ãˆã°Firebase RealtimeDatabaseã ã¨ã€users -> uidã®æã«ä»¥ä¸‹ç”»åƒã®ã‚ˆã†ãªæ„Ÿã˜ã§å„ã€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®FCM Tokenã‚’ç™»éŒ²ã—ã¦ãŠãã¾ã™ã€‚
Pushé€šçŸ¥ã‚’é€ã‚ŠãŸã„æ™‚ã«ã¯ã€é€ä¿¡å…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®uidã‹ã‚‰ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Tokenã‚’å–å¾—ã™ã‚Œã°OKã§ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/c53d9fd6955d85b5a486531d.png)

ãã®ãŸã‚ã«ã€å„ã€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«è‡ªåˆ†ã®FCM Tokenã‚’Realtime Databaseã«ä¿å­˜ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
extension AppDelegate: UNUserNotificationCenterDelegate ã«ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ä»˜ã‘è¶³ã—ã¾ã™ã€‚
```swift: ExampleApp.swift
extension AppDelegate: UNUserNotificationCenterDelegate {

   // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«FCM Tokenã‚’å–å¾—ã€ãã®å¾ŒRDBã®usersãƒ„ãƒªãƒ¼ã«Tokenã‚’ä¿å­˜
   func messaging(_ messaging: Messaging, didReceiveRegistrationToken fcmToken: String?) {
      guard let fcmToken = fcmToken else { return }
      if let uid = Auth.auth().currentUser?.uid {
         setFcmToken(uid: uid, fcmToken: fcmToken)
      }
   }

   func setFcmToken(uid: String, fcmToken: String) {
      let value = ["fcmToken": fcmToken]
      let ref = Database.database().reference().child("users").child(uid)
      ref.updateChildValues(value)
   }
```
ã“ã‚Œã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®FCM Tokenã‚’uidã«ç´ä»˜ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

# 2. Pushé€šçŸ¥é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ä½œã‚‹

Pushé€šçŸ¥ã‚’é€ã‚‹ãƒˆãƒªã‚¬ãƒ¼ã¯ã‚¢ãƒ—ãƒªã”ã¨ã«é•ã†ã®ã§ãªã‚“ã§ã‚‚è‰¯ã„ã®ã§ã™ãŒã€ã“ã“ã§ã¯å˜ç´”ã«ã€
æŠ¼ã—ãŸã‚‰ç‰¹å®šã®ç›¸æ‰‹ã«Pushé€šçŸ¥ãŒå±Šããƒœã‚¿ãƒ³ã‚’ä½œã‚Šã¾ã™ã€‚
ä¸€å¿œuidã§é€ã‚‹ç›¸æ‰‹ã‚’ç‰¹å®šã™ã‚‹ã®ã§ã€ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã®ã‚ã‚‹ã‚¢ãƒ—ãƒªã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚µãƒ³ãƒ—ãƒ«ã¯ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒ2ã¤ã‚ã‚‹TabViewã§ã™ã€‚
ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆãã®ã¾ã¾TabViewã®tag0ã«æŒ‡å®šã—ã¦ã‚ã‚‹HogeViewã¸ã€æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆã¯SignInViewã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
FugaViewã«Pushé€šçŸ¥é€ä¿¡ãƒœã‚¿ãƒ³ã‚’è¨­ç½®ã—ã€å±Šã„ãŸPushé€šçŸ¥ã‚’æŠ¼ä¸‹ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯HogeViewã§ã¯ãªãFugaViewã‚’é·ç§»ã—ãŸçŠ¶æ…‹ã§ã‚¢ãƒ—ãƒªã‚’é–‹ãã‚ˆã†ã«ã—ã¾ã™ã€‚

```swift: HomeView.swift
import SwiftUI

struct HomeView: View {
   @StateObject private var fbSession = FirebaseSession()
   @ObservedObject var homeViewModel = HomeViewModel()
   
   var body: some View {
      Group {
         if fbSession.session != nil {
	    TabView(selection: $homeViewModel.selection) {
	       HogeView(session: self.fbSession)
                  .tabItem {
                     VStack {
                        Image(systemName: "person.3.fill")
                        Text("Hoge")
                     }
                  }.tag(0)
               FugaView(session: self.fbSession)
                  .tabItem {
                     VStack {
                        Image(systemName: "ellipsis.bubble.fill")
                        Text("Fuga")
                     }
                  }.tag(1)
	   }
	} else {
	   SignInView()
	}
    }
    .environmentObject(session)
}
```
```swift: FugaView.swift
import SwiftUI

struct FugaView: View {
   @EnvironmentObject var session: FirebaseSession
   
   var body: some View {
      Spacer()
      Button(action: {
         // ã“ã“ã«Pushé€šçŸ¥é€ä¿¡ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ›¸ã
      }) {
         Text("Pushé€šçŸ¥é€ä¿¡ ğŸ“£")
      }
      Spacer()
   }
}
```

# 3. HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å‡¦ç†ã‚’å®Ÿè£…

https://fcm.googleapis.com/fcm/send ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã€é€ä¿¡å…ˆã®FCM Tokenã‚’ä»˜ä¸ã—ã¦POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ã§ã€Pushé€šçŸ¥ã‚’é€ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã¾ãŸã€ã“ã“ã§Pushé€šçŸ¥ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’æ±ºã‚ãŸã‚Šã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¨ã„ã£ã¦Pushé€šçŸ¥ã«å«ã‚ã‚‹æƒ…å ±ã‚’å®šç¾©ã—ãŸã‚Šã—ã¾ã™ã€‚
è©³ç´°ã¯[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://firebase.google.com/docs/cloud-messaging/http-server-ref?hl=ja)ã‚’å‚è€ƒã«ã—ã¦ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

å®Ÿè£…ã™ã‚‹ã«ã‚ãŸã‚Šã€CloudMessagingã®ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ¼ãŒå¿…è¦ãªã®ã§ã€ãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã™ã€‚
Firebase Console -> ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦æ¨ªã®æ­¯è»Šãƒœã‚¿ãƒ³ -> CloudMessagingã‚¿ãƒ– -> ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèªè¨¼æƒ…å ± ã«ã‚ã‚‹ã€ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ¼ã®éƒ¨åˆ†ã§ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/b88e34a81afeea23ffa2ff85.png)

```swift: PushNotificationSender.swift
import Foundation

class PushNotificationSender {
   init() {}
   private let FCM_serverKey = /* Consoleç”»é¢ã§æ§ãˆã¦ãŠã„ãŸã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ¼ */
   private let endpoint = "https://fcm.googleapis.com/fcm/send"
   
   func sendPushNotification(to token: String, userId: String, title: String, body: String, completion: @escaping () -> Void) {
      let serverKey = FCM_serverKey
      guard let url = URL(string: endpoint) else { return }
      let paramString: [String: Any] = ["to": token,
                                        "notification": ["title": title, "body": body],
                                        "data": ["userId": userId]]
      var request = URLRequest(url: url)
      request.httpMethod = "POST"
      request.httpBody = try? JSONSerialization.data(withJSONObject: paramString, options: [.prettyPrinted])
      request.setValue("application/json", forHTTPHeaderField: "Content-Type")
      request.setValue("key=\(FCM_ServerKey)", forHTTPHeaderField: "Authorization")
      let task = URLSession.shared.dataTask(with: request) { data, _, _ in
            do {
                if let jsonData = data {
                    if let jsonDataDict = try JSONSerialization.jsonObject(with: jsonData, options: JSONSerialization.ReadingOptions.allowFragments) as? [String: AnyObject] {
                        print("Received data: \(jsonDataDict)")
                    }
                }
            } catch let err as NSError {
                print(err.debugDescription)
            }
        }
	task.resume()
        completion()
   }
}
```
ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰(ä¸Šã®ã‚³ãƒ¼ãƒ‰ã§ã¯paramString)ã®"data"ã‚­ãƒ¼ã«è¾æ›¸å‹ã§ç™»éŒ²ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€å€¤ã‚’Pushé€šçŸ¥ã«å«ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä¸Šã®ã‚³ãƒ¼ãƒ‰ã§ã¯é€ä¿¡è€…ã®uidã‚’å…¥ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã‚Œã§APIã‚’å©ã‘ã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã€å…ˆç¨‹ã®FugaViewå†…ã®ãƒœã‚¿ãƒ³ã«å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚
é€ä¿¡å…ˆã®FCM Tokenã¯ç›¸æ‰‹ã®uidã‹ã‚‰å–ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€äº‹å‰ã«å–å¾—ã—ã¦ãŠãã¾ã™ã€‚
```swift: FugaView.swift
import SwiftUI

struct FugaView: View {
   @EnvironmentObject var session: FirebaseSession
   let pushNotificationSender = PushNotificationSender()
   
   var body: some View {
      Spacer()
      Button(action: {
         pushNotificationSender.sendPushNotification(
	    to: /* é€ä¿¡å…ˆã®FCM Token */,
	    userId: /* è‡ªåˆ†ã®uid */,
	    title: "Test", /* Pushé€šçŸ¥ã®ã‚¿ã‚¤ãƒˆãƒ« */
	    body: "Hello" /* Pushé€šçŸ¥ã®æœ¬æ–‡ */) {
	    print("done")
	 }
      }) {
         Text("Pushé€šçŸ¥é€ä¿¡ ğŸ“£")
      }
      Spacer()
   }
}
```
å±Šãã¾ã—ãŸï¼
![](https://storage.googleapis.com/zenn-user-upload/0a47db8b425bb709699ea4aa.jpg =250x)


# 4. Pushé€šçŸ¥ãŒã‚¿ãƒƒãƒ—ã•ã‚ŒãŸæ™‚ã®å‡¦ç†ã‚’æ›¸ã

Pushé€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã—ãŸãŒã€ç¾çŠ¶ã ã¨é€šçŸ¥ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚‚TabViewã®tag0ã«æŒ‡å®šã—ã¦ã‚ã‚‹HogeViewãŒé–‹ã‹ã‚Œã¾ã™ã€‚
ã“ã“ã§ã¯é€ä¿¡å…ƒãŒã„ã‚‹tag1ã«FugaViewã‚’é–‹ãã‚ˆã†ã«ã—ãŸã„ã®ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é–‹ã‹ã‚Œã‚‹HogeViewã‹ã‚‰FugaViewã«é·ç§»ã™ã‚‹å‡¦ç†ã‚’æ›¸ãã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ã€Pushé€šçŸ¥ãŒã‚¿ãƒƒãƒ—ã•ã‚ŒãŸæ™‚ã«å‘¼ã°ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰userNotificationCenter(didReceive response ~)å†…ã§NotificationCenterã‚’ä½¿ã£ã¦é€šçŸ¥ã‚’é€ã‚Šã€HomeViewã®ViewModelã§Combineã‚’ä½¿ã£ã¦ç›£è¦–ã€ã‚¿ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆãŒé€šçŸ¥ã•ã‚ŒãŸã‚‰TabViewã®selectionã‚’0 -> 1ã«å¤‰æ›´ã—ã€FugaViewã«é·ç§»ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

AppDelegateã«ä»¥ä¸‹ã®ãƒ‡ãƒªã‚²ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚
ã“ã‚Œã§Pushé€šçŸ¥ãŒã‚¿ãƒƒãƒ—ã•ã‚ŒãŸæ™‚ã«ã€"didReceiveRemoteNotification"ã¨ã„ã†åå‰ã§ç™»éŒ²ã—ãŸNotificationCenterã«ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ãŒã„ãã¾ã™ã€‚
```swift: ExampleApp.swift
extension AppDelegate: UNUserNotificationCenterDelegate {
   //  Pushé€šçŸ¥ãŒã‚¿ãƒƒãƒ—ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
    func userNotificationCenter(_ center: UNUserNotificationCenter, didReceive response: UNNotificationResponse, withCompletionHandler completionHandler: @escaping () -> Void) {
        let userInfo = response.notification.request.content.userInfo
        NotificationCenter.default.post(name: Notification.Name("didReceiveRemoteNotification"), object: nil, userInfo: userInfo)
        completionHandler()
    }
}
```

æ¬¡ã«HomeViewModelã‚’æ›¸ãã¾ã™ã€‚
HomeViewå†…ã®TabViewã¯ã€HomeViewModelã®selectionã‚’ã¿ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
selectionã«ã¯@Publishã‚’ä»˜ã‘ã¦ã„ã‚‹ã®ã§ã€å€¤ã«å¤‰åŒ–ãŒã‚ã£ãŸæ™‚ã«ãã®å¤‰æ›´ã‚’HomeViewã«çŸ¥ã‚‰ã›ã¾ã™ã€‚
ã¾ãŸã€Pushé€šçŸ¥ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«ã¯é€ä¿¡å…ƒã®uidã‚’å«ã‚ã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚‚ã“ã“ã§å–ã‚Šå‡ºã—ã¦ã„ã¾ã™ã€‚
```swift
TabView(selection: $homeViewModel.selection)
```

```swift: HomeViewModel.swift
import SwiftUI
import Combine

class HomeViewModel: ObservableObject {
   @Published var selection = 0
   var cancellable: AnyCancellable?
   var userId = ""
   
   init() {
      cancellable = NotificationCenter.default
         .publisher(for: Notification.Name("didReceiveRemoteNotification"))
         .sink { notification in
	    if let userInfo = notification.userInfo, let userId = userInfo["userId"] {
               self.userId = userId as? String ?? ""
            }
            self.selection = 1
         }
   }
```
ã“ã‚Œã§Pushé€šçŸ¥ãŒã‚¿ãƒƒãƒ—ã•ã‚ŒãŸæ™‚ã«HogeViewã§ã¯ãªãFugaViewã‚’é–‹ãã‚ˆã†ã«ã§ãã¾ã—ãŸï¼ğŸ‰
ä»Šå›ã¯TabViewå†…ã§ã®é·ç§»ã§ã—ãŸãŒã€åŒã˜ã‚ˆã†ã‚„ã‚Œã°sheetãªã©ä»–ã®é·ç§»æ–¹æ³•ã§ã‚‚ã§ãã¾ã™ã€‚

ãœã²è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚


